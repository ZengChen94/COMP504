package model.strategy;

import model.Ball;
import model.IBallCmd;
import model.IUpdateStrategy;
import model.MultiInteractStrategy;
import util.IDispatcher;

// Or, using lambda expressions:
public class AverageStrategy<TDispMsg> implements IUpdateStrategy<TDispMsg> {

	public void init(Ball context) {
		context.setInteractStrategy(new MultiInteractStrategy(context.getInteractStrategy(), (contextBall, targetBall, disp) -> disp.deleteObserver(targetBall)));
	}

	@SuppressWarnings("unchecked")
	@Override
	public void updateState(Ball context, IDispatcher<TDispMsg> dispatcher) {
		// No-op
		dispatcher.dispatch((TDispMsg) new IBallCmd(){
			@Override
			public void apply(Ball other, IDispatcher<IBallCmd> dispatcher) {
				if(context != other){
					double distance = context.getLocation().distance(other.getLocation());
					if (distance <= (context.getRadius()+other.getRadius())) {
						double contextMass = context.getRadius() * context.getRadius();
						double otherMass = other.getRadius() * other.getRadius();
						double averageMass = (contextMass+otherMass)/2;
						context.setRadius((int) Math.sqrt(averageMass));
						other.setRadius((int) Math.sqrt(averageMass));
					}
				}
			}
		});
	}
}
