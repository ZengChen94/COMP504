package chatapp.model.object.receiver;

import java.io.Serializable;
import java.rmi.RemoteException;
import java.util.UUID;

import javax.swing.ImageIcon;

import chatapp.model.ICmd2CRModelViewAdapter;
import chatapp.model.datapacket.algo.DataPacketChatRoomAlgo;
import chatapp.model.datapacket.cmd.DefaultCmd;
import chatapp.model.datapacket.cmd.DisplayImageCmd;
import chatapp.model.datapacket.cmd.DisplayTextCmd;
import chatapp.model.datapacket.cmd.JoinChatRoomCmd;
import chatapp.model.datapacket.cmd.LeaveChatRoomCmd;
import chatapp.model.datapacket.data.RequestCmdData;
import common.DataPacketAlgoCmd;
import common.DataPacketChatRoom;
import common.IAddReceiverType;
import common.IReceiver;
import common.IRemoveReceiverType;
import common.IRequestCmdType;
import common.IUser;

/**
 * The receiver for a chat room.
 *
 */
public class Receiver implements IReceiver, Serializable {
		
	private static final long serialVersionUID = -80343119221410606L;
	/**
	 * The userStub for this receiver.
	 */
	private IUser userStub;
	/**
	 * The uuid of this receiver.
	 */
	private UUID uuid = UUID.randomUUID();
	/**
	 * The command to chat room model adapter.
	 */
	private transient ICmd2CRModelViewAdapter cmd2CRModelViewAdapter;
	/**
	 * The algo to execute data packets the receiver received.
	 */
	private DataPacketChatRoomAlgo algo;
	/**
	 * Constructor.
	 * @param userStub is the userStub of this receiver.
	 * @param iCmd2CRModelViewAdapter is the receiver to chat room model adapter.
	 */
	public Receiver(IUser userStub, ICmd2CRModelViewAdapter iCmd2CRModelViewAdapter) {
		this.userStub = userStub;
		this.cmd2CRModelViewAdapter = iCmd2CRModelViewAdapter;
		// set the well know algos
		algo = new DataPacketChatRoomAlgo(new DefaultCmd<>(iCmd2CRModelViewAdapter));
		algo.setCmd(ImageIcon.class, new DisplayImageCmd(iCmd2CRModelViewAdapter));
		algo.setCmd(String.class, new DisplayTextCmd(iCmd2CRModelViewAdapter));
		algo.setCmd(IAddReceiverType.class, new JoinChatRoomCmd(iCmd2CRModelViewAdapter));
		algo.setCmd(IRemoveReceiverType.class, new LeaveChatRoomCmd(iCmd2CRModelViewAdapter));
	}

	@Override
	public <T> void receive(DataPacketChatRoom<T> data) throws RemoteException {
		Class<?> id = data.getData().getClass();
		IReceiver sender = data.getSender();
		@SuppressWarnings("unchecked")
		DataPacketAlgoCmd<T> cmd = (DataPacketAlgoCmd<T>) this.algo.getCmd(id);
		if (cmd == null) {
			System.out.println("missing cmd, request cmd from sender: " + sender);
			sender.receive(new DataPacketChatRoom<IRequestCmdType>(IRequestCmdType.class, new RequestCmdData(id), sender));
			cmd = cmd == null ? new DefaultCmd<T>(cmd2CRModelViewAdapter) : cmd; // necessary?
		}
		cmd.setCmd2ModelAdpt(cmd2CRModelViewAdapter);
		algo.setCmd(id, cmd);
		data.execute(algo);
	}

	@Override
	public IUser getUserStub() throws RemoteException {
		return userStub;
	}

	@Override
	public UUID getUUID() throws RemoteException {
		return uuid;
	}
}
