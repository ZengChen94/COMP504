package chatapp.model.object.receiver;

import java.io.Serializable;
import java.rmi.RemoteException;
import java.util.UUID;

import javax.swing.ImageIcon;

import chatapp.model.ICmd2CRModelViewAdapter;
import chatapp.model.datapacket.algo.DataPacketChatRoomAlgo;
import chatapp.model.datapacket.cmd.DisplayImageCmd;
import chatapp.model.datapacket.cmd.DisplayTextCmd;
import chatapp.model.datapacket.data.FailureStatusData;
import chatapp.model.datapacket.data.InstallCmdData;
import chatapp.model.datapacket.data.RequestCmdData;
import common.DataPacketAlgoCmd;
import common.DataPacketChatRoom;
import common.IAddReceiverType;
import common.ICmd2ModelAdapter;
import common.IFailureStatusType;
import common.IInstallCmdType;
import common.IReceiver;
import common.IRemoveReceiverType;
import common.IRequestCmdType;
import common.IUser;

/**
 * The receiver for a chat room.
 *
 */
public class Receiver implements IReceiver, Serializable {
		
	private static final long serialVersionUID = -80343119221410606L;
	/**
	 * The userStub for this receiver.
	 */
	private IUser userStub;
	/**
	 * The uuid of this receiver.
	 */
	private UUID uuid = UUID.randomUUID();
	/**
	 * The command to chat room model adapter.
	 */
	private transient ICmd2CRModelViewAdapter cmd2CRModelViewAdapter;
	/**
	 * The algo to execute data packets the receiver received.
	 */
	private DataPacketChatRoomAlgo algo;
	/**
	 * Constructor.
	 * @param userStub is the userStub of this receiver.
	 * @param cmd2CRModelViewAdapter is the receiver to chat room model adapter.
	 */
	public Receiver(IUser userStub, ICmd2CRModelViewAdapter cmd2CRModelViewAdapter) {
		this.userStub = userStub;
		this.cmd2CRModelViewAdapter = cmd2CRModelViewAdapter;
		// well known algos.
		// initialize the algo and set the default command.
		algo = new DataPacketChatRoomAlgo(new DataPacketAlgoCmd<String>() {

			private static final long serialVersionUID = 5549709735057012897L;

			@Override
			public String apply(Class<?> id, DataPacketChatRoom<String> host, String... params) {
				IReceiver sender = host.getSender();
				Receiver.this.cmd2CRModelViewAdapter.appendMsg("missing cmd, requesting cmd from sender: " + sender);
				try {
					sender.receive(new DataPacketChatRoom<IRequestCmdType>(IRequestCmdType.class, new RequestCmdData(id), sender));
				} catch (RemoteException e) {
					System.out.println("failed to request cmd from sender: + " + sender);
					e.printStackTrace();
				}
				DataPacketAlgoCmd<?> cmd = (DataPacketAlgoCmd<?>) Receiver.this.algo.getCmd(id);
				cmd = cmd == null ? new DataPacketAlgoCmd<String>() {
					private static final long serialVersionUID = -8399492353791319982L;
					@Override
					public String apply(Class<?> index, DataPacketChatRoom<String> host, String... params) {
						Receiver.this.cmd2CRModelViewAdapter.appendMsg("still received null cmd, use self defined null command");
						return "use self defined null command";
					}
					@Override
					public void setCmd2ModelAdpt(ICmd2ModelAdapter cmd2ModelAdpt) {}
				} : cmd;
				cmd.setCmd2ModelAdpt(cmd2CRModelViewAdapter);
				return null;
			}

			@Override
			public void setCmd2ModelAdpt(ICmd2ModelAdapter cmd2ModelAdpt) {}
			
		});
		// add receiver command.
		algo.setCmd(IAddReceiverType.class, new DataPacketAlgoCmd<IAddReceiverType>() {

			private static final long serialVersionUID = 445855638505927139L;

			@Override
			public String apply(Class<?> index, DataPacketChatRoom<IAddReceiverType> host, String... params) {
				IReceiver receiver = host.getData().getReceiverStub();
				Receiver.this.cmd2CRModelViewAdapter.addReceiver(receiver);
				return "receiver: " + receiver + " added";
			}

			@Override
			public void setCmd2ModelAdpt(ICmd2ModelAdapter cmd2ModelAdpt) {}
			
		});
		// remove receiver command
		algo.setCmd(IRemoveReceiverType.class, new DataPacketAlgoCmd<IRemoveReceiverType>() {

			private static final long serialVersionUID = -5292044967833187117L;

			@Override
			public String apply(Class<?> index, DataPacketChatRoom<IRemoveReceiverType> host, String... params) {
				IReceiver sender = host.getSender();
				Receiver.this.cmd2CRModelViewAdapter.removeReceiver(sender);
				return null;
			}

			@Override
			public void setCmd2ModelAdpt(ICmd2ModelAdapter cmd2ModelAdpt) {}
			
		});
		// execute failure status command
		algo.setCmd(IFailureStatusType.class, new DataPacketAlgoCmd<FailureStatusData<String>>() {

			private static final long serialVersionUID = -1857161355501646599L;

			@Override
			public String apply(Class<?> index, DataPacketChatRoom<FailureStatusData<String>> host, String... params) {
				cmd2CRModelViewAdapter.appendMsg(host.getData().getFailureInfo());
				return null;
			}

			@Override
			public void setCmd2ModelAdpt(ICmd2ModelAdapter cmd2ModelAdpt) {}
		});
		// request cmd command
		algo.setCmd(IRequestCmdType.class, new DataPacketAlgoCmd<RequestCmdData>() {

			private static final long serialVersionUID = -2609602603430750073L;

			@Override
			public String apply(Class<?> index, DataPacketChatRoom<RequestCmdData> host, String... params) {
				IReceiver sender = host.getSender();
				Class<?> id = host.getData().getCmdId();
				DataPacketAlgoCmd<?> cmd = (DataPacketAlgoCmd<?>) algo.getCmd(id);
				try {
					sender.receive(new DataPacketChatRoom<IInstallCmdType>(
							IInstallCmdType.class, 
							new InstallCmdData(id, cmd), 
							Receiver.this));
				} catch (RemoteException e) {
					System.out.println("failed to send cmd back to receiver: " + Receiver.this + " for install");
					e.printStackTrace();
				}
				return null;
			}

			@Override
			public void setCmd2ModelAdpt(ICmd2ModelAdapter cmd2ModelAdpt) {}
		});
		// install cmd command
		algo.setCmd(IInstallCmdType.class, new DataPacketAlgoCmd<IInstallCmdType>() {
			
			private static final long serialVersionUID = 2773448536986212690L;

			@Override
			public String apply(Class<?> index, DataPacketChatRoom<IInstallCmdType> host, String... params) {
				IInstallCmdType data = host.getData();
				Class<?>  id = data.getClass();
				DataPacketAlgoCmd<?> cmd = data.getCmd();
				cmd.setCmd2ModelAdpt(cmd2CRModelViewAdapter);
				algo.setCmd(id, cmd);
				return null;
			}

			@Override
			public void setCmd2ModelAdpt(ICmd2ModelAdapter cmd2ModelAdpt) {}
		});
		algo.setCmd(ImageIcon.class, new DisplayImageCmd(cmd2CRModelViewAdapter));
		algo.setCmd(String.class, new DisplayTextCmd(cmd2CRModelViewAdapter));
	}

	@Override
	public <T> void receive(DataPacketChatRoom<T> data) throws RemoteException {
		data.execute(algo);
	}

	@Override
	public IUser getUserStub() throws RemoteException {
		return userStub;
	}

	@Override
	public UUID getUUID() throws RemoteException {
		return uuid;
	}
}
